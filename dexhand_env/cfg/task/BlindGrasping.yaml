# @package _global_
# BlindGrasping task configuration - inherits from BaseTask
defaults:
  - BaseTask
  - _self_

# Override only RL environment timing
sim:
  dt: 0.01                     # Task-specific 100Hz physics timing
  # substeps + physx parameters inherited from physics/accurate.yaml

# Environment and world setup
env:
  numEnvs: ${env.numEnvs}
  episodeLength: 500  # 10 seconds at 50Hz
  # Box properties
  box:
    size: 0.05  # 5cm cube
    mass: 0.1   # 100g
    friction: 1.0
    restitution: 0.0
    initial_position:
      xy_range: 0.02    # ±2cm randomization
      z: 0.027          # Fixed on table (box half-size + small clearance for accurate physics)

train:
  maxIterations: 30000
  logging:
    rewardLogInterval: 1000

# Task configuration - all RL-related settings
task:
  name: BlindGrasping

  # Velocity limits
  max_base_linear_velocity: 0.1
  max_base_angular_velocity: 0.5
  max_finger_joint_velocity: 0.5  # Reduced for more controlled movements

  # Contact detection
  contact_binary_threshold: 0.1

  # Penetration prevention parameters
  penetration_prevention:
    geometricPenetrationFactor: 1.0         # Fraction of half box size for detection
    proximityMinDistanceFactor: 1.0         # Minimum distance clamp for proximity reward
    penetrationDepthScale: 100.0            # Scaling factor for continuous penetration penalty

  # Policy observation keys - what the policy actually sees (blind policy design)
  policy_observation_keys:
    - base_dof_pos
    - active_finger_dof_pos
    - base_dof_vel
    - active_finger_dof_vel
    - contact_binary      # Primary sensing
    - contact_duration    # Temporal sensing
    - hand_pose          # Correct key name (not hand_base_pose)
    - prev_actions
    - fingertip_poses_world
    - fingerpad_poses_world  # Fingerpad poses for better grasping control
    - first_three_fingerpad_centroid  # Centroid of first 3 fingerpads for spatial awareness
    - episode_time       # Episode progress
    - fingerpad_distances # Pairwise distances between fingerpads
    - current_stage      # Stage state machine (0=pre-grasp, 1=grasp, 2=lift)
    - time_in_stage      # Time spent in current stage (seconds)
    - stage_progress     # Progress through current stage (0.0-1.0)
    # NO box observations - policy is blind!
    # grasp_duration is privileged info - not exposed to policy

  # Termination criteria
  termination:
    # Specify which criteria are active (fail-fast if any are missing)
    active_success_criteria: ["grasp_lift_success"]
    active_failure_criteria: ["hitting_ground", "box_too_far", "stage1_pregrasp_failed", "stage2_contact_failed", "stage3_grasp_lost"]

    # Height thresholds for ground collision detection
    height_safety:
      handbase_threshold: 0.0
      fingertip_threshold: 0.0
      fingerpad_threshold: 0.0

  # Task-specific parameters (flattened from taskParams)
  success_height_threshold: 0.2     # Object must be lifted above this height (meters)
  contact_duration_threshold: 2.0   # Minimum contact duration for success (seconds)
  min_fingers_for_grasp: 2          # Minimum number of fingers required for valid grasp
  max_box_distance: 0.8             # Reset if box moves beyond this distance (meters)

  # Stage timing parameters for multi-stage approach
  stage1_duration: 4.0               # Pre-grasp stage duration (seconds)
  stage2_duration: 3.0               # Grasp stage max duration before timeout (seconds)
  # Stage 3 (lift) has no duration limit - ends with success/failure

  # Hand randomization parameters
  hand_translation_range: 0.2        # ±0.2m randomization for ARTx, ARTy, ARTz
  hand_rotation_range: 0.785         # ±45° (π/4 radians) for ARRx, ARRy, ARRz

  # Finger randomization parameters
  finger_randomization:
    thumb_rotation_range: 1.571     # 0-90 degrees (π/2 radians) for r_f_joint1_1
    other_finger_range: 0.524       # 0-30 degrees (π/6 radians) for other finger DOFs

  # Stage evaluation parameters
  stage_evaluation:
    stage2_contact_success_threshold: 0.5      # Contact duration for stage 2 success

  # Reward calculation parameters
  reward_calculation:
    height_alignment_decay: 5.0                # Exponential decay factor for height alignment
    centroid_positioning_decay: 5.0           # Exponential decay factor for centroid positioning
    object_stability_decay: 100.0              # Exponential decay factor for object stability
    first_three_height_consistency_decay: 50.0 # Exponential decay factor for first three fingerpad height consistency
    fingerpad_proximity_decay: 10.0            # Exponential decay factor for Stage 2 fingerpad proximity to object
    base_stability_decay: 3.0                # Exponential decay factor for hand base stability during Stage 2

  # Quality evaluation thresholds
  quality_thresholds:
    height_tolerance: 0.03                     # Height tolerance for pregrasp quality (meters)
    centroid_tolerance: 0.08                   # Centroid distance tolerance (meters)
    position_drift_tolerance: 0.01            # Position drift tolerance (meters)
    velocity_tolerance: 0.005                  # Velocity magnitude tolerance (m/s)


  # Visual settings
  visualization:
    box_color: [0.5, 0.8, 1.0]                # RGB color for box (light blue)

  # Reward weights configuration - override BaseTask completely
  reward_weights:
    _delete_: true  # Delete parent rewardWeights to ensure BlindGrasping has complete control

    # Unified stage-based reward system (removes redundancy)
    # Stage 1: Pre-grasp rewards
    s1_height_alignment: 0.3      # Height alignment reward
    s1_centroid_positioning: 1.0  # Centroid positioning reward
    s1_object_stability: 0.2               # Object stability reward
    s1_finger_height_consistency: 0.4  # Height consistency reward for first three fingerpads
    s1_thumb_rotation: 0.3   # Reward for thumb rotation near 90° during Stage 1

    # Stage 2: Contact establishment
    s2_thumb_contact: 1.5           # Reward for thumb contact specifically
    s2_other_fingers_contact: 1.0   # Reward for other finger contact
    s2_grasp_achievement: 5.0              # Grasp formation reward
    s2_fingerpad_proximity: 2.5     # Reward for fingerpads approaching object during Stage 2
    s2_base_stability: 2.0          # Reward for stable hand base during contact establishment

    # Stage 3: Lifting rewards
    s3_object_height: 10.0                  # Main reward for lifting object
    s3_grasp_maintenance: 10.0              # Reward for maintaining grasp during lift
    s3_grasp_duration: 2.0                 # Reward for maintaining grasp duration

    # Stage completion bonuses (one-time when transitioning)
    s1_completion: 500.0            # Bonus for completing stage 1 (pre-grasp)
    s2_completion: 1000.0           # Bonus for completing stage 2 (grasp)

    # Penetration prevention
    penetration_penalty: -100.0     # Strong penalty for penetration behavior

    # Termination rewards (one-time at episode end)
    termination_success: 2000.0       # Large bonus for successful grasp and lift
    termination_failure_penalty: 200.0       # Penalty for failure (touching ground, etc.)
    termination_timeout_penalty: 200.0       # Penalty for not completing task

    # Explicitly disable BaseTask rewards (set to 0.0)
    alive: 0.0                      # No alive bonus for BlindGrasping
    height_safety: 0.0              # No height safety penalty (handled by termination)
    finger_velocity: 0.0            # No velocity penalties
    hand_velocity: 0.0
    hand_angular_velocity: 0.0
    joint_limit: 0.0                # No joint limit penalties
    finger_acceleration: 0.0        # No acceleration penalties
    hand_acceleration: 0.0
    hand_angular_acceleration: 0.0
    contact_stability: 0.0          # No contact stability reward
